<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>仓库作业 / 창고 작업</title>

  <!-- 扫码/二维码库 -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- 四件套：样式 -->
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <div class="header">
    <div>
      <div class="title">仓库作业 / 창고 작업</div>
      <div class="subtitle">CK 仓库 · Incheon</div>
    </div>
    <div class="pill" id="netPill">Online</div>
  </div>

  <!-- 全局状态 -->
  <div class="card">
    <small>device_id（每台手机固定） / 기기ID</small>
    <div id="device"></div>
    <small>当前 session_id（本趟作业ID） / 현재 작업ID</small>
    <div id="session"></div>
    <div id="status" class="pill" style="margin-top:8px;">Ready</div>
  </div>

  <!-- HOME -->
  <div id="page-home" class="page">
    <div class="card">
      <h3>入口 / 메뉴</h3>
      <div class="gridHome">
        <button class="primary" onclick="go('global_menu')">
          总控台 <small>Global</small><br><small>全局在岗 / 总览</small>
        </button>
        <button class="primary" onclick="go('badge')">
          工牌 <small>명찰</small><br><small>日当/员工 批量生成</small>
        </button>
        <button class="primary" onclick="go('b2c_menu')">
          B2C<br><small>拣货 / 换单 / 打包贴单</small>
        </button>
        <button class="primary" onclick="comingSoon('进口快件（待上线）')">
          进口快件 <small>수입 택배</small><br><small>卸货/过机/装柜</small>
        </button>
        <button class="primary" onclick="comingSoon('B2B（待上线）')">
          B2B<br><small>卸货/工单/装车</small>
        </button>
      </div>
    </div>
  </div>

  <!-- GLOBAL MENU -->
  <div id="page-global_menu" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">总控台 / Global</div>
    </div>

    <div class="card">
      <button class="primary" onclick="go('active_now')">全局在岗（已上线） <small>Active Now</small></button>
      <button class="primary" onclick="go('badge')">工牌 / Badge <small>명찰</small></button>
      <button class="primary" onclick="go('b2c_menu')">B2C <small>피킹/라벨/포장</small></button>
      <button class="ghost" onclick="comingSoon('进口快件（待上线）')">进口快件（待上线）</button>
      <button class="ghost" onclick="comingSoon('B2B（待上线）')">B2B（待上线）</button>
    </div>
  </div>

  <!-- ACTIVE NOW (GLOBAL) -->
  <div id="page-active_now" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">全局在岗 / Active Now</div>
    </div>

    <div class="card">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <button class="primary" onclick="refreshActiveNow()">刷新 <small>새로고침</small></button>
        <div id="activeNowMeta" class="muted"></div>
      </div>

      <div id="activeNowSummary" style="margin-top:10px;"></div>
      <div id="activeNowList" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- BADGE -->
  <div id="page-badge" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">工牌 / 명찰</div>
    </div>

    <div class="card">
      <h3>日当工牌 / 일용직 명찰</h3>

      <small>今天日当人数 N / 오늘 인원</small>
      <input id="daCount" type="number" min="1" max="200" placeholder="例如 10" />
      <button class="primary" onclick="bulkDailyCheckin()">批量生成日当工牌 <small>일괄 생성</small></button>

      <button onclick="dailyCheckin()">生成单个日当工牌 <small>1명 생성</small></button>

      <div><small>最近生成工牌 / 최근 명찰</small></div>
      <div id="daText">无</div>

      <button onclick="bindBadgeToSession()">绑定工牌到当前趟次 <small>현재 작업에 연결</small></button>
      <small id="daStatus" class="muted"></small>

      <div id="badgeList" style="margin-top:10px;" class="grid2"></div>
    </div>

    <div class="card">
      <h3>长期日当工牌 / 장기 일용직 명찰（DAF-001|名字）</h3>
      <div class="muted">一人一张，长期使用（不需要每天生成）。扫码记录里会带名字。</div>

      <small>姓名列表（每行一个） / 이름 목록</small>
      <textarea id="daPermanentNames" placeholder="张三&#10;李四&#10;김민수&#10;박지훈"></textarea>

      <div class="row">
        <div>
          <small>起始编号 / 시작 번호</small>
          <input id="daPermanentStart" type="number" min="1" max="9999" value="1" />
        </div>
        <div>
          <small>位数（001/01） / 자릿수</small>
          <input id="daPermanentPad" type="number" min="2" max="6" value="3" />
        </div>
      </div>

      <button class="primary" onclick="generatePermanentDaBadges()">批量生成长期日当工牌 <small>일괄 생성</small></button>
      <div id="daPermanentList" style="margin-top:10px;" class="grid2"></div>
    </div>

    <div class="card">
      <h3>员工工牌 / 직원 명찰（EMP-001|名字）</h3>
      <div class="muted">名字一行一个粘贴 → 生成二维码：EMP-001|张三（支持韩文姓名）。</div>

      <small>员工姓名列表（每行一个） / 이름 목록</small>
      <textarea id="empNames" placeholder="张三&#10;李四&#10;김민수&#10;박지훈"></textarea>

      <div class="row">
        <div>
          <small>起始编号 / 시작 번호</small>
          <input id="empStart" type="number" min="1" max="999" value="1" />
        </div>
        <div>
          <small>位数（001/01） / 자릿수</small>
          <input id="empPad" type="number" min="2" max="4" value="3" />
        </div>
      </div>

      <button class="primary" onclick="generateEmployeeBadges()">批量生成员工工牌 <small>직원 명찰 생성</small></button>
      <div id="empBadgeList" style="margin-top:10px;" class="grid2"></div>
    </div>
  </div>

  <!-- B2C MENU -->
  <div id="page-b2c_menu" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 菜单 / ��뉴</div>
    </div>

    <div class="card">
      <!-- ✅ 加入已有趟次 / 显示趟次二维码 -->
      <button class="primary" onclick="joinExistingSessionByScan()">加入已有趟次（扫码） <small>세션 참여</small></button>
      <button class="primary" onclick="showSessionQr()">显示当前趟次二维码 <small>세션 QR</small></button>
      <div class="listBox" style="margin-top:10px;">
        <div class="muted">让其他设备扫描本机二维码即可加入同一趟次（session）。</div>
        <div id="b2cSessionQrBox" style="margin-top:10px;"></div>
      </div>

      <!-- ✅ 你确认的顺序：入库理货 -> 拣货 -> 验货贴单打包 -> 退件入库 -> 质检 -> 废弃处理 -> 换单 -->
      <button class="primary" onclick="go('b2c_tally')">入库理货（已上线） <small>입고검수</small></button>
      <button class="primary" onclick="go('b2c_pick')">拣货（已上线） <small>피킹</small></button>
      <button class="primary" onclick="go('b2c_pack')">验货贴单打包（开始/结束扫工牌） <small>검수·포장·라벨</small></button>
      <button class="primary" onclick="go('b2c_return')">退件入库（开始/结束扫工牌） <small>반품 입고</small></button>
      <button class="primary" onclick="go('b2c_qc')">质检（开始/结束扫工牌） <small>검품</small></button>
      <button class="primary" onclick="go('b2c_disposal')">废弃处理（开始/结束扫工牌） <small>폐기</small></button>
      <button class="primary" onclick="go('b2c_relabel')">换单（已上线） <small>라벨</small></button>

      <button class="ghost" onclick="comingSoon('B2C 其他环节')">其他环节（待上线） <small>준비중</small></button>
    </div>
  </div>

  <!-- ✅ B2C TALLY -->
  <div id="page-b2c_tally" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 入库理货 / 입고검수</div>
    </div>

    <div class="card">
      <div class="muted">口径：开始/结束 + 人员加入/退出 + 入库单号扫码（去重计数）。</div>

      <button class="primary" onclick="startTally()">开始理货 <small>시작</small></button>

      <button class="primary" onclick="joinWork('B2C','TALLY')">加入作业（扫工牌） <small>참여</small></button>
      <button class="primary" onclick="leaveWork('B2C','TALLY')">退出作业（扫工牌） <small>퇴장</small></button>

      <div class="listBox">
        <div><b>当前参与名单 / 참여자</b>：<span id="tallyCount">0</span></div>
        <div id="tallyActiveList" class="muted">无 / 없음</div>
      </div>

      <button class="primary" onclick="openScannerInboundCount()">扫码入库单号（计数/去重） <small>입고번호</small></button>

      <div class="listBox">
        <div><b>已扫入库单（去重）</b>：<span id="inboundCount">0</span></div>
        <div id="inboundList" class="muted">无 / 없음</div>
      </div>

      <button class="primary" onclick="endTally()">结束理货 <small>종료</small></button>
    </div>
  </div>

  <!-- ✅ B2C RETURN（改成 PACK 方式：开始/结束都扫工牌） -->
  <div id="page-b2c_return" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 退件入库 / 반품 입고</div>
    </div>

    <div class="card">
      <div class="pill">✅ 记录方式：开始=扫工牌；结束=扫工牌（同一工牌不能同时在其它任务中）</div>

      <button class="primary" onclick="joinWork('B2C','退件入库')">开始作业（扫工牌） <small>시작(명찰 스캔)</small></button>
      <button class="primary" onclick="leaveWork('B2C','退件入库')">结束作业（扫工牌） <small>종료(명찰 스캔)</small></button>

      <div class="listBox">
        <div><b>当前在岗 / 작업중</b>：<span id="returnCount">0</span></div>
        <div id="returnActiveList" class="muted">无 / 없음</div>
      </div>

      <div class="pill" style="margin-top:10px;">
        📌 人效/时效：用退件入库 join~leave 的时段，在本地模型匹配 WMS 导出的退件订单/认领表的签收时间计算产能。
      </div>
    </div>
  </div>

  <!-- ✅ NEW: B2C 质检（PACK 方式） -->
  <div id="page-b2c_qc" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 质检 / 검품</div>
    </div>

    <div class="card">
      <div class="pill">✅ 记录方式：开始=扫工牌；结束=扫工牌（同一工牌不能同时在其它任务中）</div>

      <button class="primary" onclick="joinWork('B2C','质检')">开始作业（扫工牌） <small>시작(명찰 스캔)</small></button>
      <button class="primary" onclick="leaveWork('B2C','质检')">结束作业（扫工牌） <small>종료(명찰 스캔)</small></button>

      <div class="listBox">
        <div class="muted">如需显示当前在岗名单，可后续在 app.js 增加 activeQC 渲染。</div>
      </div>
    </div>
  </div>

  <!-- ✅ NEW: B2C 废弃处理（PACK 方式） -->
  <div id="page-b2c_disposal" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 废弃处理 / 폐기</div>
    </div>

    <div class="card">
      <div class="pill">✅ 记录方式：开始=扫工牌；结束=扫工牌（同一工牌不能同时在其它任务中）</div>

      <button class="primary" onclick="joinWork('B2C','废弃处理')">开始作业（扫工牌） <small>시작(명찰 스캔)</small></button>
      <button class="primary" onclick="leaveWork('B2C','废弃处理')">结束作业（扫工牌） <small>종료(명찰 스캔)</small></button>

      <div class="listBox">
        <div class="muted">如需显示当前在岗名单，可后续在 app.js 增加 activeDisposal 渲染。</div>
      </div>
    </div>
  </div>

  <!-- B2C PICK -->
  <div id="page-b2c_pick" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 拣货 / 피킹</div>
    </div>

    <div class="card">
      <button class="primary" onclick="startPicking()">开始拣货 <small>시작</small></button>

      <button class="primary" onclick="joinWork('B2C','PICK')">加入作业（扫工牌） <small>참여</small></button>
      <button class="primary" onclick="leaveWork('B2C','PICK')">退出作业（扫工牌） <small>퇴장</small></button>

      <div class="listBox">
        <div><b>当前参与名单 / 참여자</b>：<span id="pickCount">0</span></div>
        <div id="pickActiveList" class="muted">无 / 없음</div>
      </div>

      <button class="primary" onclick="openScannerWave()">扫码波次 <small>웨이브</small></button>

      <button class="primary" onclick="leaderLoginPick()">组长登录（扫码） <small>팀장 로그인</small></button>
      <div class="pill" id="leaderInfoPick" style="margin-top:6px;">组长未登录 / 팀장 미로그인</div>

      <button class="primary" id="btnEndPick" style="display:none;" onclick="endPicking()">结束拣货（组长确认） <small>종료</small></button>
    </div>
  </div>

  <!-- B2C RELABEL（只改名字显示为“换单”） -->
  <div id="page-b2c_relabel" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 换单 / 라벨</div>
    </div>

    <div class="card">
      <div class="muted">本页面只记录开始/结束 + 加入/退出（0额外扫码）。</div>

      <button class="primary" onclick="startRelabel()">开始换单 <small>시작</small></button>

      <button class="primary" onclick="joinWork('B2C','RELABEL')">加入作业（扫工牌） <small>참여</small></button>
      <button class="primary" onclick="leaveWork('B2C','RELABEL')">退出作业（扫工牌） <small>퇴장</small></button>

      <div class="listBox">
        <div><b>当前参与名单 / 참여자</b>：<span id="relabelCount">0</span></div>
        <div id="relabelActiveList" class="muted">无 / 없음</div>
      </div>

      <button class="primary" onclick="endRelabel()">结束换单 <small>종료</small></button>
      <div class="pill" id="relabelTimer" style="margin-top:10px;">未开始 / 미시작</div>
    </div>
  </div>

  <!-- B2C PACK（只改菜单/标题的中文为“验货贴单打包”，实际 task 仍是 PACK） -->
  <div id="page-b2c_pack" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 验货贴单打包 / 검수·포장·라벨</div>
    </div>

    <div class="card">
      <div class="pill">✅ 开始=扫工牌；结束=扫工牌（同一工牌不能同时在其它任务中）</div>

      <button class="primary" onclick="joinWork('B2C','PACK')">开始作业（扫工牌） <small>시작(명찰 스캔)</small></button>
      <button class="primary" onclick="leaveWork('B2C','PACK')">结束作业（扫工牌） <small>종료(명찰 스캔)</small></button>

      <div class="listBox">
        <div><b>当前在岗 / 작업중</b>：<span id="packCount">0</span></div>
        <div id="packActiveList" class="muted">无 / 없음</div>
      </div>

      <div class="pill" style="margin-top:10px;">
        📌 产出不在这里扫码：用 PACK 的 start~end 时间段匹配系统导出的当日出库数据（发货时间）计算人效。
      </div>
    </div>
  </div>

  <!-- 全屏扫码浮层 -->
  <div id="scannerOverlay" class="overlay">
    <div class="overlayCard">
      <div class="overlayTop">
        <div class="grow">
          <div class="overlayTitle" id="scanTitle">扫码 / 스캔</div>
          <div class="overlayHint">请对准二维码 / 바코드를 화면 중앙에 맞추세요</div>
        </div>
        <button class="small" style="width:auto;min-width:90px" onclick="closeScanner()">关闭 <small>닫기</small></button>
      </div>
      <div id="reader"></div>
    </div>
  </div>

  <!-- 四件套：先 UI 再 App -->
  <script src="./ui.js"></script>
  <script src="./app.js"></script>
</body>
</html>
