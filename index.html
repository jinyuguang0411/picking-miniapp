<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Picking Mini App</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body{font-family:system-ui;margin:16px}
    button{padding:12px 14px;margin:6px 0;width:100%;font-size:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
    small{color:#666}
    .ok{color:#0a0}
    .bad{color:#b00}
  </style>
</head>
<body>
  <h2>拣货 / 피킹</h2>

  <div class="card">
    <small>设备ID（每台手机自动固定）</small>
    <div id="device"></div>
    <small>当前拣货趟次 pick_session_id</small>
    <div id="session"></div>
    <small id="status"></small>
  </div>

  <div class="card">
    <button onclick="startPicking()">开始拣货 / 시작</button>
    <button onclick="openScanner()">扫码波次 / 웨이브 스캔</button>
    <button onclick="endPicking()">结束拣货 / 종료</button>
  </div>
  <div class="card">
  <h3>日当 / 일용직</h3>
    <button onclick="dailyCheckin()">生成工牌（签到）/ 출근 등록</button>
    <div><small>da_id</small></div>
    <div id="daText">无</div>
    <button onclick="bindDaily()">绑定工牌到当前趟次 / 명찰 연결</button>
    <small id="daStatus"></small>
  </div>
  
  <div class="card" id="scannerCard" style="display:none;">
    <h3>扫码波次</h3>
    <div id="reader" style="width:100%"></div>
    <button onclick="closeScanner()">关闭扫码 / 닫기</button>
  </div>

<script>
const FORM_URL = "https://docs.google.com/forms/u/0/d/e/1FAIpQLSer3mWq6A6OivAJKba5JE--CwlKnU6Teru586HCOZVoJo6qQg/formResponse";
const ENTRY_EVENT = "entry.806252256";
const ENTRY_DEVICE = "entry.1221756343";
const ENTRY_SESSION = "entry.139498995";
const ENTRY_WAVE = "entry.2002106420";
const ENTRY_TS = "entry.179441545";
const ENTRY_DA = "entry.1739228641";

let scanner = null;
let currentSessionId = localStorage.getItem("pick_session_id") || null;
let scannedWaves = new Set();     // 本趟已扫波次
let lastScanAt = 0;              // 防抖：避免一秒内重复触发

function nowTs(){ return String(Date.now()); }

function makeDeviceId(){
  let id = localStorage.getItem("device_id");
  if(!id){
    id = "DEV-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString().slice(-6);
    localStorage.setItem("device_id", id);
  }
  return id;
}

function makePickSessionId(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `PS-${yyyy}${mm}${dd}-${hh}${mi}${ss}-${makeDeviceId().slice(-6)}`;
}

function setStatus(msg, ok=true){
  const el = document.getElementById("status");
  el.className = ok ? "ok" : "bad";
  el.textContent = msg;
}

function beep(){
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 880;      // 音高
    g.gain.value = 0.05;          // 音量（别太大）
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120); // 120ms
  }catch(e){
    // 某些环境禁用音频，忽略即可
  }
}

function refreshUI(){
  document.getElementById("device").textContent = makeDeviceId();
  document.getElementById("session").textContent = currentSessionId || "无 / 없음";
}
refreshUI();

async function submitEvent({event, pick_session_id, wave_id="", da_id=""}){
  const fd = new FormData();
  fd.append(ENTRY_EVENT, event);
  fd.append(ENTRY_DEVICE, makeDeviceId());
  fd.append(ENTRY_SESSION, pick_session_id || "NA");
  fd.append(ENTRY_WAVE, wave_id);
  fd.append(ENTRY_TS, nowTs());
  fd.append(ENTRY_DA, da_id);     // 新增：日当ID（可空）
  await fetch(FORM_URL, { method:"POST", mode:"no-cors", body: fd });
}

async function startPicking(){
  try{
    if(currentSessionId){
      setStatus("继续上一趟 / 이전 세션 계속", true);
      return;
    }
    currentSessionId = makePickSessionId();
    localStorage.setItem("pick_session_id", currentSessionId);
    scannedWaves = new Set();
    await submitEvent({ event:"start", pick_session_id: currentSessionId });
    refreshUI();
    setStatus("开始已记录 ✅", true);
  }catch(e){
    setStatus("开始失败 ❌ " + e, false);
  }
}

async function endPicking(){
  try{
    if(!currentSessionId){
      setStatus("没有未结束趟次", false);
      return;
    }
    await submitEvent({ event:"end", pick_session_id: currentSessionId });
    setStatus("结束已记录 ✅", true);
    currentSessionId = null;
    localStorage.removeItem("pick_session_id");
    refreshUI();
  }catch(e){
    setStatus("结束失败 ❌ " + e, false);
  }
}

async function openScanner(){
  if(!currentSessionId){
    setStatus("请先开始拣货", false);
    return;
  }
  document.getElementById("scannerCard").style.display = "block";
  document.getElementById("reader").innerHTML = "";

  scanner = new Html5Qrcode("reader");

  // 先尝试直接用后置摄像头（environment）
  try{
    await scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 240, height: 240 } },
      async (decodedText) => {
  const code = decodedText.trim();

  // 防抖：1秒内只处理一次
  const now = Date.now();
  if (now - lastScanAt < 1000) return;
  lastScanAt = now;

  // 波次格式校验
  const ok = /^\d{4}-\d{4}-\d+$/.test(code);
  if(!ok){
    setStatus("波次格式不对（例：2026-0224-6）", false);
    return;
  }

  // 去重：同一趟同一波次只记一次
  if (scannedWaves.has(code)) {
    // 震动反馈（手机支持的话）
    if (navigator.vibrate) navigator.vibrate(80);
    setStatus("重复波次已忽略 ⏭️ " + code, false);
    return;
  }

  // 先把它加入集合，避免并发重复
  scannedWaves.add(code);

  // 提交事件
  await submitEvent({ event:"wave", pick_session_id: currentSessionId, wave_id: code });

  beep();
  // 强反馈：震动 + 弹窗 + 状态
  if (navigator.vibrate) navigator.vibrate([60, 30, 60]);
  alert("已记录波次 ✅ " + code);
  setStatus("已记录波次 ✅ " + code, true);
}
    );
    setStatus("已打开后置摄像头 ✅", true);
    return;
  }catch(e){
    // 如果 facingMode 不支持/被拒绝，就走下面的摄像头列表
  }

  // fallback：从摄像头列表里挑一个更像后置的
  const cams = await Html5Qrcode.getCameras();
  let camId = cams?.[0]?.id;

  // 尝试用名字包含 back/rear/environment 的摄像头
  if(cams && cams.length){
    const prefer = cams.find(c => /back|rear|environment/i.test(c.label));
    if(prefer) camId = prefer.id;
  }

  await scanner.start(
    camId,
    { fps: 10, qrbox: { width: 240, height: 240 } },
    async (decodedText) => {
      const code = decodedText.trim();
      const ok = /^\d{4}-\d{4}-\d+$/.test(code);
      if(!ok){
        setStatus("波次格式不对（例：2026-0224-6）", false);
        return;
      }
      await submitEvent({ event:"wave", pick_session_id: currentSessionId, wave_id: code });
      setStatus("已记录波次 ✅ " + code, true);
    }
  );
  setStatus("已打开摄像头 ✅", true);
}

async function closeScanner(){
  try{
    if(scanner){
      await scanner.stop();
      await scanner.clear();
      scanner = null;
    }
  }catch(e){}
  document.getElementById("scannerCard").style.display = "none";
}

let currentDaId = localStorage.getItem("da_id") || null;

// 生成 DA-YYYYMMDD-序号（每台手机每天从01开始）
function makeDaId(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const key = `da_seq_${yyyy}${mm}${dd}`;
  let seq = parseInt(localStorage.getItem(key) || "0", 10) + 1;
  localStorage.setItem(key, String(seq));
  return `DA-${yyyy}${mm}${dd}-${String(seq).padStart(2,'0')}`;
}

function setDaStatus(msg, ok=true){
  const el = document.getElementById("daStatus");
  el.className = ok ? "ok" : "bad";
  el.textContent = msg;
}

function refreshDaUI(){
  document.getElementById("daText").textContent = currentDaId || "无";
}
refreshDaUI();

// 日当签到（生成工牌并写入表）
async function dailyCheckin(){
  try{
    currentDaId = makeDaId();
    localStorage.setItem("da_id", currentDaId);

    // 写入表：daily_checkin（pick_session_id 用 NA）
    await submitEvent({ event:"daily_checkin", pick_session_id:"NA", da_id: currentDaId });

    refreshDaUI();
    alert("工牌已生成 ✅ " + currentDaId + "\n请截图/打印这张页面并贴在日当身上");
    setDaStatus("签到已记录 ✅", true);
  }catch(e){
    setDaStatus("签到失败 ❌ " + e, false);
  }
}

// 绑定工牌：需要先开始拣货，再扫工牌二维码（DA-...）
async function bindDaily(){
  try{
    if(!currentSessionId){
      setDaStatus("请先开始拣货再绑定工牌", false);
      return;
    }
    // 打开扫码，但此处扫的是 da_id（工牌）
    await openScannerBadge();
  }catch(e){
    setDaStatus("绑定失败 ❌ " + e, false);
  }
}

// 单独的“扫工牌”扫码器（不和波次混）
async function openScannerBadge(){
  document.getElementById("scannerCard").style.display = "block";
  document.getElementById("reader").innerHTML = "";

  // 关闭旧scanner
  try{ if(scanner){ await scanner.stop(); await scanner.clear(); } }catch(e){}
  scanner = new Html5Qrcode("reader");

  // 优先后置
  const onScan = async (decodedText) => {
    const code = decodedText.trim();
    // 基本校验：DA-YYYYMMDD-xx
    const ok = /^DA-\d{8}-\d+$/.test(code);
    if(!ok){
      setDaStatus("这不是有效工牌（DA-YYYYMMDD-xx）", false);
      return;
    }

    // 写入表：bind_daily
    await submitEvent({ event:"bind_daily", pick_session_id: currentSessionId, da_id: code });

    currentDaId = code;
    localStorage.setItem("da_id", currentDaId);
    refreshDaUI();

    alert("已绑定工牌 ✅ " + code);
    setDaStatus("已绑定到本趟 ✅", true);

    // 绑定成功后关闭扫码
    await closeScanner();
  };

  try{
    await scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 240, height: 240 } },
      onScan
    );
  }catch(e){
    // fallback
    const cams = await Html5Qrcode.getCameras();
    const camId = cams?.[0]?.id;
    await scanner.start(camId, { fps:10, qrbox:{width:240,height:240}}, onScan);
  }
}

</script>
</body>
</html>
