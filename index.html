<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>仓库作业 / 창고 작업</title>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body{font-family:system-ui;margin:16px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .title{font-size:22px;font-weight:800}
    .subtitle{font-size:12px;color:#666;margin-top:2px}
    .pill{padding:6px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#333;display:inline-block}

    .card{border:1px solid #ddd;border-radius:16px;padding:14px;margin:12px 0;background:#fff}
    .row{display:flex;gap:10px}
    .row > *{flex:1}

    button{
      padding:14px 14px;margin:8px 0;width:100%;
      font-size:16px;border-radius:14px;border:1px solid #ddd;background:#fff;cursor:pointer;
    }
    button.primary{border-color:#000;background:#000;color:#fff;font-weight:700;}
    button.ghost{background:#fff;border-style:dashed;}
    button.small{padding:10px 12px;font-size:14px}

    input, textarea{padding:10px;width:100%;font-size:16px;margin:6px 0;box-sizing:border-box}
    textarea{min-height:90px;resize:vertical}

    small{color:#666}
    .ok{color:#0a0}
    .bad{color:#b00}
    .muted{color:#666}

    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .gridHome{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .gridHome button{height:92px;text-align:left;line-height:1.15}
    .gridHome small{color:rgba(255,255,255,.85)}
    .listBox{border:1px dashed #ddd;border-radius:12px;padding:10px;margin-top:8px}
    .tag{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;font-size:12px}
    .topbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .topbar .back{width:auto;min-width:90px}
    .topbar .grow{flex:1}

    /* ===== Fullscreen Scanner Overlay ===== */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.65);
      display:none;
      z-index:9999;
      padding:16px;
    }
    .overlay.show{display:flex; align-items:center; justify-content:center;}
    .overlayCard{
      width:min(520px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid #ddd;
      padding:14px;
    }
    .overlayTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .overlayTitle{font-size:18px;font-weight:800}
    .overlayHint{font-size:12px;color:#666;margin-top:2px}
    #reader{
      width:100%;
      border-radius:14px;
      overflow:hidden;
    }
  </style>
</head>

<body>
  <div class="header">
    <div>
      <div class="title">仓库作业 / 창고 작업</div>
      <div class="subtitle">CK 仓库 · Incheon</div>
    </div>
    <div class="pill" id="netPill">Online</div>
  </div>

  <!-- 全局状态 -->
  <div class="card">
    <small>device_id（每台手机固定） / 기기ID</small>
    <div id="device"></div>
    <small>当前 pick_session_id（本趟作业ID） / 현재 작업ID</small>
    <div id="session"></div>
    <div id="status" class="pill" style="margin-top:8px;">Ready</div>
  </div>

  <!-- HOME -->
  <div id="page-home" class="page">
    <div class="card">
      <h3>入口 / 메뉴</h3>
      <div class="gridHome">
        <button class="primary" onclick="go('badge')">
          工牌 <small>명찰</small><br><small>日当/员工 批量生成</small>
        </button>
        <button class="primary" onclick="go('b2c_menu')">
          B2C<br><small>拣货 / 换单贴单</small>
        </button>
        <button class="primary" onclick="go('import')">
          进口快件 <small>수입 택배</small><br><small>卸货/过机/装柜</small>
        </button>
        <button class="primary" onclick="go('b2b')">
          B2B<br><small>卸货/工单/装车</small>
        </button>
      </div>
    </div>
  </div>

  <!-- BADGE -->
  <div id="page-badge" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">工牌 / 명찰</div>
    </div>

    <div class="card">
      <h3>日当工牌 / 일용직 명찰</h3>

      <small>今天日当人数 N / 오늘 인원</small>
      <input id="daCount" type="number" min="1" max="200" placeholder="例如 10" />
      <button class="primary" onclick="bulkDailyCheckin()">批量生成日当工牌 <small>일괄 생성</small></button>

      <button onclick="dailyCheckin()">生成单个日当工牌 <small>1명 생성</small></button>

      <div><small>最近生成工牌 / 최근 명찰</small></div>
      <div id="daText">无</div>

      <button onclick="bindBadgeToSession()">绑定工牌到当前趟次 <small>현재 작업에 연결</small></button>
      <small id="daStatus" class="muted"></small>

      <div id="badgeList" style="margin-top:10px;" class="grid2"></div>
    </div>

    <div class="card">
      <h3>员工工牌 / 직원 명찰（EMP-001|名字）</h3>
      <div class="muted">名字一行一个粘贴 → 生成二维码：EMP-001|张三（支持韩文姓名）。</div>

      <small>员工姓名列表（每行一个） / 이름 목록</small>
      <textarea id="empNames" placeholder="张三&#10;李四&#10;김민수&#10;박지훈"></textarea>

      <div class="row">
        <div>
          <small>起始编号 / 시작 번호</small>
          <input id="empStart" type="number" min="1" max="999" value="1" />
        </div>
        <div>
          <small>位数（001/01） / 자릿수</small>
          <input id="empPad" type="number" min="2" max="4" value="3" />
        </div>
      </div>

      <button class="primary" onclick="generateEmployeeBadges()">批量生成员工工牌 <small>직원 명찰 생성</small></button>
      <div id="empBadgeList" style="margin-top:10px;" class="grid2"></div>
    </div>
  </div>

  <!-- B2C MENU -->
  <div id="page-b2c_menu" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 菜单 / 메뉴</div>
    </div>

    <div class="card">
      <button class="primary" onclick="go('b2c_pick')">拣货（已上线） <small>피킹(사용중)</small></button>
      <button class="primary" onclick="go('b2c_relabel')">扫码贴单/换单（埋点） <small>스캔·라벨(기록)</small></button>

      <button class="ghost" onclick="comingSoon('B2C 验货打包贴单 / 검수·포장·라벨')">验货打包贴单（待上线） <small>준비중</small></button>
      <button class="ghost" onclick="comingSoon('B2C 退件入库 / 반품 입고')">退件入库（待上线） <small>준비중</small></button>
      <button class="ghost" onclick="comingSoon('B2C 退件质检 / 반품 검품')">退件质检（待上线） <small>준비중</small></button>
      <button class="ghost" onclick="comingSoon('B2C 问题件处理 / 문제건 처리')">问题件处理（待上线） <small>준비중</small></button>
    </div>
  </div>

  <!-- B2C PICK -->
  <div id="page-b2c_pick" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 拣货 / 피킹</div>
    </div>

    <div class="card">
      <button class="primary" onclick="startPicking()">开始拣货 <small>시작</small></button>

      <button class="primary" onclick="joinWork('B2C','PICK')">加入作业（扫工牌） <small>참여(입장)</small></button>
      <button class="primary" onclick="leaveWork('B2C','PICK')">退出作业（扫工牌） <small>퇴장(종료)</small></button>

      <div class="listBox">
        <div><b>当前参与名单 / 참여자</b>：<span id="pickCount">0</span></div>
        <div id="pickActiveList" class="muted">无 / 없음</div>
      </div>

      <button class="primary" onclick="openScannerWave()">扫码波次 <small>웨이브 스캔</small></button>

      <button class="primary" onclick="leaderLoginPick()">组长登录（扫码） <small>팀장 로그인</small></button>
      <div class="pill" id="leaderInfoPick" style="margin-top:6px;">组长未登录 / 팀장 미로그인</div>

      <button class="primary" id="btnEndPick" style="display:none;" onclick="endPicking()">结束拣货（组长确认） <small>종료(팀장 확인)</small></button>

      <div class="pill" style="margin-top:10px;">
        ✅ 规则：组长只点【开始/扫波次/结束】；拣货员只点【加入/退出】。<br>
        ✅ A拣完小货位：点【退出作业】即可，不要结束拣货。<br>
        ✅ 还有人没退出时，系统不允许组长结束。
      </div>
    </div>
  </div>

  <!-- B2C RELABEL -->
  <div id="page-b2c_relabel" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2C 换单贴单 / 라벨</div>
    </div>

    <div class="card">
      <div class="muted">实物扫码/打印/贴单在出单系统完成，本页面只记录开始/结束 + 加入/退出（0额外扫码）。</div>

      <button class="primary" onclick="startRelabel()">开始换单 <small>시작</small></button>

      <button class="primary" onclick="joinWork('B2C','RELABEL')">加入作业（扫工牌） <small>참여(입장)</small></button>
      <button class="primary" onclick="leaveWork('B2C','RELABEL')">退出作业（扫工牌） <small>퇴장(종료)</small></button>

      <div class="listBox">
        <div><b>当前参与名单 / 참여자</b>：<span id="relabelCount">0</span></div>
        <div id="relabelActiveList" class="muted">无 / 없음</div>
      </div>

      <button class="primary" onclick="endRelabel()">结束换单 <small>종료</small></button>
      <div class="pill" id="relabelTimer" style="margin-top:10px;">未开始 / 미시작</div>
    </div>
  </div>

  <!-- IMPORT -->
  <div id="page-import" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">进口快件 / 수입 택배</div>
    </div>

    <div class="card">
      <button class="ghost" onclick="comingSoon('进口快件 卸货 / 하역')">卸货（待上线） <small>준비중</small></button>
      <button class="ghost" onclick="comingSoon('进口快件 过机扫描 / 컨베이어 스캔')">过机扫描（待上线） <small>준비중</small></button>
      <button class="ghost" onclick="comingSoon('进口快件 装柜出库 / 상차·출고')">装柜出库（待上线） <small>준비중</small></button>
    </div>
  </div>

  <!-- B2B -->
  <div id="page-b2b" class="page" style="display:none;">
    <div class="topbar">
      <button class="back small" onclick="back()">返回 <small>뒤로</small></button>
      <div class="grow pill">B2B</div>
    </div>

    <div class="card">
      <button class="ghost" onclick="comingSoon('B2B 卸货（散箱/整托/整柜）')">卸货（散箱/整托/整柜）（待上线） <small>준비중</small></button>
      <button class="ghost" onclick="comingSoon('B2B 工单操作')">工单操作（待上线） <small>준备중</small></button>
      <button class="ghost" onclick="comingSoon('B2B 装车装柜')">装车装柜（待上线） <small>준비중</small></button>
    </div>
  </div>

  <!-- ===== Fullscreen Scanner Overlay ===== -->
  <div id="scannerOverlay" class="overlay">
    <div class="overlayCard">
      <div class="overlayTop">
        <div class="grow">
          <div class="overlayTitle" id="scanTitle">扫码 / 스캔</div>
          <div class="overlayHint">请对准二维码 / 바코드를 화면 중앙에 맞추세요</div>
        </div>
        <button class="small" style="width:auto;min-width:90px" onclick="closeScanner()">关闭 <small>닫기</small></button>
      </div>
      <div id="reader"></div>
    </div>
  </div>

<script>
/** ===== Google Form mapping ===== */
const FORM_URL = "https://docs.google.com/forms/u/0/d/e/1FAIpQLSer3mWq6A6OivAJKba5JE--CwlKnU6Teru586HCOZVoJo6qQg/formResponse";
const ENTRY_EVENT   = "entry.806252256";
const ENTRY_DEVICE  = "entry.1221756343";
const ENTRY_SESSION = "entry.139498995";
const ENTRY_WAVE    = "entry.2002106420";
const ENTRY_TS      = "entry.179441545";
const ENTRY_DA      = "entry.1739228641";
const ENTRY_BIZ     = "entry.1934762358";
const ENTRY_TASK    = "entry.53174481";

/** ===== Hash Router ===== */
const pages = ["home","badge","b2c_menu","b2c_pick","b2c_relabel","import","b2b"];
function setHash(page){ location.hash = "#/" + page; }
function getHashPage(){
  const h = (location.hash || "").trim();
  if(!h || h === "#") return "home";
  const m = h.match(/^#\/(.+)$/);
  if(!m) return "home";
  const p = m[1];
  return pages.includes(p) ? p : "home";
}
function renderPages(){
  const cur = getHashPage();
  for(const p of pages){
    const el = document.getElementById("page-"+p);
    if(el) el.style.display = (p===cur) ? "block" : "none";
  }
  if(cur==="b2c_pick"){ syncLeaderPickUI(); renderActiveLists(); }
  if(cur==="b2c_relabel"){ renderActiveLists(); }
}
window.addEventListener("hashchange", renderPages);
function go(p){ setHash(p); }
function back(){ if(history.length > 1) history.back(); else setHash("home"); }
if(!location.hash) setHash("home");
renderPages();

/** ===== Global state ===== */
let scanner = null;
let scanMode = null; // wave | badgeBind | labor | leaderLoginPick | leaderEndPick
let currentSessionId = localStorage.getItem("pick_session_id") || null;
let scannedWaves = new Set();
let lastScanAt = 0;
let currentDaId = localStorage.getItem("da_id") || null;

/** labor */
let laborAction = null;
let laborBiz = null;
let laborTask = null;

/** participants */
let activePick = new Set();
let activeRelabel = new Set();

/** relabel timer */
let relabelTimerHandle = null;
let relabelStartTs = null;

/** leader */
let leaderPickBadge = localStorage.getItem("leader_pick_badge") || null;
let leaderPickOk = false;
let pendingLeaderEnd = null;

/** ===== Utilities ===== */
function nowTs(){ return String(Date.now()); }
function makeDeviceId(){
  let id = localStorage.getItem("device_id");
  if(!id){
    id = "DEV-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString().slice(-6);
    localStorage.setItem("device_id", id);
  }
  return id;
}
function makePickSessionId(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `PS-${yyyy}${mm}${dd}-${hh}${mi}${ss}-${makeDeviceId().slice(-6)}`;
}
function setStatus(msg, ok=true){
  const el = document.getElementById("status");
  el.className = "pill " + (ok ? "ok" : "bad");
  el.textContent = msg;
}
function refreshUI(){
  document.getElementById("device").textContent = makeDeviceId();
  document.getElementById("session").textContent = currentSessionId || "无 / 없음";
}
refreshUI();

function comingSoon(name){ alert(`${name}\n还未上线 / 아직 준비중`); }

/** ===== Network pill ===== */
function refreshNet(){
  const el = document.getElementById("netPill");
  if(!el) return;
  el.textContent = navigator.onLine ? "Online" : "Offline";
  el.style.borderColor = navigator.onLine ? "#0a0" : "#b00";
}
window.addEventListener("online", refreshNet);
window.addEventListener("offline", refreshNet);
refreshNet();

/** ===== Submit event ===== */
async function submitEvent({event, biz, task, pick_session_id, wave_id="", da_id=""}){
  const fd = new FormData();
  fd.append(ENTRY_EVENT, event);
  fd.append(ENTRY_DEVICE, makeDeviceId());
  fd.append(ENTRY_SESSION, pick_session_id || "NA");
  fd.append(ENTRY_WAVE, wave_id);
  fd.append(ENTRY_TS, nowTs());
  fd.append(ENTRY_DA, da_id);
  fd.append(ENTRY_BIZ, biz);
  fd.append(ENTRY_TASK, task);
  await fetch(FORM_URL, { method:"POST", mode:"no-cors", body: fd });
}

/** ===== Badge helpers ===== */
function parseBadge(code){
  const raw = (code || "").trim();
  const parts = raw.split("|");
  const id = (parts[0] || "").trim();
  const name = (parts[1] || "").trim();
  return { raw, id, name };
}
function isDaId(id){ return /^DA-\d{8}-\d+$/.test(id); }
function isEmpId(id){ return /^EMP-[A-Za-z0-9_-]+$/.test(id); }
function isOperatorBadge(raw){
  const p = parseBadge(raw);
  return isDaId(p.id) || isEmpId(p.id);
}

/** ===== Active list rendering ===== */
function badgeDisplay(raw){
  const p = parseBadge(raw);
  return p.name ? `${p.id}｜${p.name}` : p.id;
}
function renderSetToHtml(setObj){
  const arr = Array.from(setObj);
  if(arr.length === 0) return `<span class="muted">无 / 없음</span>`;
  return arr.map(x => `<span class="tag">${badgeDisplay(x)}</span>`).join("");
}
function renderActiveLists(){
  const pc = document.getElementById("pickCount");
  const pl = document.getElementById("pickActiveList");
  if(pc) pc.textContent = String(activePick.size);
  if(pl) pl.innerHTML = renderSetToHtml(activePick);

  const rc = document.getElementById("relabelCount");
  const rl = document.getElementById("relabelActiveList");
  if(rc) rc.textContent = String(activeRelabel.size);
  if(rl) rl.innerHTML = renderSetToHtml(activeRelabel);
}

/** ===== Leader UI ===== */
function syncLeaderPickUI(){
  const info = document.getElementById("leaderInfoPick");
  const btnEnd = document.getElementById("btnEndPick");
  if(!info || !btnEnd) return;

  if(leaderPickOk && leaderPickBadge){
    info.textContent = `组长已登录 ✅ ${leaderPickBadge}`;
    btnEnd.style.display = "block";
  }else{
    info.textContent = leaderPickBadge ? `组长未确认（本趟需登录）: ${leaderPickBadge}` : "组长未登录 / 팀장 미로그인";
    btnEnd.style.display = "none";
  }
}

/** ===== Leader actions ===== */
async function leaderLoginPick(){
  if(!currentSessionId){
    setStatus("请先开始拣货再组长登录 / 먼저 시작", false);
    return;
  }
  scanMode = "leaderLoginPick";
  document.getElementById("scanTitle").textContent = "扫码组长工牌登录 / 팀장 로그인";
  await openScannerCommon();
}

/** ===== Labor ===== */
async function joinWork(biz, task){
  if(!currentSessionId){
    setStatus("请先开始该作业再加入 / 먼저 시작", false);
    return;
  }
  laborAction = "join";
  laborBiz = biz;
  laborTask = task;
  scanMode = "labor";
  document.getElementById("scanTitle").textContent = "扫码工牌（加入） / 명찰 스캔(입장)";
  await openScannerCommon();
}
async function leaveWork(biz, task){
  if(!currentSessionId){
    setStatus("请先开始该作业再退出 / 먼저 시작", false);
    return;
  }
  laborAction = "leave";
  laborBiz = biz;
  laborTask = task;
  scanMode = "labor";
  document.getElementById("scanTitle").textContent = "扫码工牌（退出） / 명찰 스캔(퇴장)";
  await openScannerCommon();
}

/** ===== PICK ===== */
async function startPicking(){
  try{
    if(currentSessionId){
      setStatus("还有未结束趟次（请先结束）/ 먼저 종료", false);
      return;
    }
    currentSessionId = makePickSessionId();
    localStorage.setItem("pick_session_id", currentSessionId);
    scannedWaves = new Set();

    leaderPickOk = false;
    syncLeaderPickUI();

    activePick = new Set();
    renderActiveLists();

    await submitEvent({ event:"start", biz:"B2C", task:"PICK", pick_session_id: currentSessionId });
    refreshUI();
    setStatus("拣货开始已记录 ✅ / 시작 기록됨", true);
  }catch(e){
    setStatus("拣货开始失败 ❌ " + e, false);
  }
}
async function openScannerWave(){
  if(!currentSessionId){
    setStatus("请先开始拣货 / 먼저 시작", false);
    return;
  }
  scanMode = "wave";
  document.getElementById("scanTitle").textContent = "扫码波次 / 웨이브 스캔";
  await openScannerCommon();
}
async function endPicking(){
  try{
    if(!currentSessionId){
      setStatus("没有未结束趟次 / 열린 세션 없음", false);
      return;
    }
    if(!leaderPickOk){
      setStatus("需要组长先登录（扫码）/ 팀장 로그인 필요", false);
      return;
    }
    if(activePick.size > 0){
      setStatus("还有人员未退出，禁止结束（请让他们 leave）", false);
      alert("还有人员未退出作业，不能结束拣货。\n请让所有参与者点【退出作业】并扫码工牌。");
      return;
    }
    pendingLeaderEnd = { biz:"B2C", task:"PICK" };
    scanMode = "leaderEndPick";
    document.getElementById("scanTitle").textContent = "扫码组长工牌确认结束 / 팀장 종료 확인";
    await openScannerCommon();
  }catch(e){
    setStatus("结束确认失败 ❌ " + e, false);
  }
}

/** ===== RELABEL ===== */
function setRelabelTimerText(text){
  const el = document.getElementById("relabelTimer");
  if(el) el.textContent = text;
}
function startRelabelTimer(){
  if(relabelTimerHandle) clearInterval(relabelTimerHandle);
  relabelTimerHandle = setInterval(()=>{
    if(!relabelStartTs) return;
    const sec = Math.floor((Date.now() - relabelStartTs)/1000);
    const mm = String(Math.floor(sec/60)).padStart(2,'0');
    const ss = String(sec%60).padStart(2,'0');
    setRelabelTimerText(`进行中 / 진행중: ${mm}:${ss}`);
  }, 1000);
}
async function startRelabel(){
  try{
    if(currentSessionId){
      setStatus("还有未结束趟次（请先结束）/ 먼저 종료", false);
      return;
    }
    currentSessionId = makePickSessionId();
    localStorage.setItem("pick_session_id", currentSessionId);

    activeRelabel = new Set();
    renderActiveLists();

    relabelStartTs = Date.now();
    setRelabelTimerText("进行中 / 진행중: 00:00");
    startRelabelTimer();

    await submitEvent({ event:"start", biz:"B2C", task:"RELABEL", pick_session_id: currentSessionId });
    refreshUI();
    setStatus("换单开始已记录 ✅（0额外扫码）", true);
  }catch(e){
    setStatus("换单开始失败 ❌ " + e, false);
  }
}
async function endRelabel(){
  try{
    if(!currentSessionId){
      setStatus("没有未结束趟次 / 열린 세션 없음", false);
      return;
    }
    if(activeRelabel.size > 0){
      setStatus("还有人员未退出，建议先 leave（否则人时不准）", false);
      alert("还有人员未退出作业。\n建议先让所有参与者点【退出作业】扫码，再结束。");
      return;
    }

    await submitEvent({ event:"end", biz:"B2C", task:"RELABEL", pick_session_id: currentSessionId });

    if(relabelTimerHandle) clearInterval(relabelTimerHandle);
    relabelTimerHandle = null;

    const endTs = Date.now();
    const sec = relabelStartTs ? Math.floor((endTs - relabelStartTs)/1000) : 0;
    const mm = String(Math.floor(sec/60)).padStart(2,'0');
    const ss = String(sec%60).padStart(2,'0');
    setRelabelTimerText(`已结束 / 종료됨: ${mm}:${ss}（按该时间段导出出单明细）`);

    setStatus("换单结束已记录 ✅", true);

    currentSessionId = null;
    localStorage.removeItem("pick_session_id");
    refreshUI();
  }catch(e){
    setStatus("换单结束失败 ❌ " + e, false);
  }
}

/** ===== Daily badges ===== */
function setDaStatus(msg, ok=true){
  const el = document.getElementById("daStatus");
  el.className = ok ? "ok" : "bad";
  el.textContent = msg;
}
function refreshDaUI(){
  document.getElementById("daText").textContent = currentDaId || "无";
}
refreshDaUI();

function makeDaId(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const key = `da_seq_${yyyy}${mm}${dd}`;
  let seq = parseInt(localStorage.getItem(key) || "0", 10) + 1;
  localStorage.setItem(key, String(seq));
  return `DA-${yyyy}${mm}${dd}-${String(seq).padStart(2,'0')}`;
}
async function dailyCheckin(){
  try{
    const da = makeDaId();
    currentDaId = da;
    localStorage.setItem("da_id", currentDaId);

    await submitEvent({ event:"daily_checkin", biz:"DAILY", task:"BADGE", pick_session_id:"NA", da_id: da });

    refreshDaUI();
    alert("日当工牌已生成 ✅ " + da);
    setDaStatus("已记录 ✅", true);

    const listEl = document.getElementById("badgeList");
    const box = document.createElement("div");
    box.style.border = "1px solid #ddd";
    box.style.borderRadius = "12px";
    box.style.padding = "10px";
    box.innerHTML = `<div style="font-weight:700;margin-bottom:6px;">${da}</div><div id="qr_${da}"></div>`;
    listEl.prepend(box);
    new QRCode(document.getElementById(`qr_${da}`), { text: da, width: 160, height: 160 });
  }catch(e){
    setDaStatus("失败 ❌ " + e, false);
  }
}
async function bulkDailyCheckin(){
  try{
    const n = parseInt(document.getElementById("daCount").value || "0", 10);
    if(!n || n < 1) return alert("请输入人数 N（>=1）");

    const listEl = document.getElementById("badgeList");
    listEl.innerHTML = "";
    setDaStatus("生成中...", true);

    for(let i=0;i<n;i++){
      const da = makeDaId();
      await submitEvent({ event:"daily_checkin", biz:"DAILY", task:"BADGE", pick_session_id:"NA", da_id: da });

      const box = document.createElement("div");
      box.style.border = "1px solid #ddd";
      box.style.borderRadius = "12px";
      box.style.padding = "10px";
      box.innerHTML = `<div style="font-weight:700;margin-bottom:6px;">${da}</div><div id="qr_${da}"></div>`;
      listEl.appendChild(box);

      new QRCode(document.getElementById(`qr_${da}`), { text: da, width: 160, height: 160 });

      currentDaId = da;
      localStorage.setItem("da_id", currentDaId);
    }

    refreshDaUI();
    setDaStatus(`批量生成完成 ✅ 共 ${n} 个（可截图/打印）`, true);
    alert("批量日当工牌已生成 ✅ 可截图/打印。");
  }catch(e){
    setDaStatus("批量生成失败 ❌ " + e, false);
  }
}

async function bindBadgeToSession(){
  try{
    if(!currentSessionId){
      setDaStatus("请先开始某个作业再绑定 / 먼저 시작", false);
      return;
    }
    scanMode = "badgeBind";
    document.getElementById("scanTitle").textContent = "扫码工牌（绑定） / 명찰 연결";
    await openScannerCommon();
  }catch(e){
    setDaStatus("绑定失败 ❌ " + e, false);
  }
}

/** ===== Employee badge generator ===== */
function padNum(n, width){
  const s = String(n);
  if(s.length >= width) return s;
  return "0".repeat(width - s.length) + s;
}
function normalizeNames(text){
  return (text || "")
    .split(/\r?\n/)
    .map(s => s.trim())
    .filter(Boolean);
}
function generateEmployeeBadges(){
  const names = normalizeNames(document.getElementById("empNames").value);
  if(names.length === 0){
    alert("请先输入员工名字（每行一个）");
    return;
  }
  const start = parseInt(document.getElementById("empStart").value || "1", 10);
  const pad = parseInt(document.getElementById("empPad").value || "3", 10);

  const listEl = document.getElementById("empBadgeList");
  listEl.innerHTML = "";

  names.forEach((name, idx) => {
    const num = start + idx;
    const empId = "EMP-" + padNum(num, pad);
    const payload = `${empId}|${name}`;

    const box = document.createElement("div");
    box.style.border = "1px solid #ddd";
    box.style.borderRadius = "12px";
    box.style.padding = "10px";
    box.innerHTML = `<div style="font-weight:700;margin-bottom:6px;">${payload}</div><div id="empqr_${empId}_${idx}"></div>`;
    listEl.appendChild(box);

    new QRCode(document.getElementById(`empqr_${empId}_${idx}`), { text: payload, width: 160, height: 160 });
  });

  alert(`已生成员工工牌 ✅ 共 ${names.length} 个\n建议截图/打印此页面发放。`);
}

/** ===== Fullscreen scanner ===== */
function showOverlay(){
  document.getElementById("scannerOverlay").classList.add("show");
}
function hideOverlay(){
  document.getElementById("scannerOverlay").classList.remove("show");
}
async function openScannerCommon(){
  showOverlay();
  document.getElementById("reader").innerHTML = "";

  try{ if(scanner){ await scanner.stop(); await scanner.clear(); } }catch(e){}
  scanner = new Html5Qrcode("reader");

  const onScan = async (decodedText) => {
    const code = decodedText.trim();

    const now = Date.now();
    if (now - lastScanAt < 1000) return;
    lastScanAt = now;

    if(scanMode === "wave"){
      const ok = /^\d{4}-\d{4}-\d+$/.test(code);
      if(!ok){ setStatus("波次格式不对（例：2026-0224-6）", false); return; }
      if(scannedWaves.has(code)){ setStatus("重复波次已忽略 ⏭️ " + code, false); return; }
      scannedWaves.add(code);

      await submitEvent({ event:"wave", biz:"B2C", task:"PICK", pick_session_id: currentSessionId, wave_id: code });
      alert("已记录波次 ✅ " + code);
      setStatus("已记录波次 ✅ " + code, true);
      return;
    }

    if(scanMode === "badgeBind"){
      if(!isOperatorBadge(code)){ setDaStatus("无效工牌（DA-... 或 EMP-...|名字）", false); return; }
      const p = parseBadge(code);
      await submitEvent({ event:"bind_daily", biz:"DAILY", task:"BADGE", pick_session_id: currentSessionId, da_id: p.raw });
      currentDaId = p.raw; localStorage.setItem("da_id", currentDaId); refreshDaUI();
      alert("已绑定工牌 ✅ " + p.raw);
      setDaStatus("绑定成功 ✅", true);
      await closeScanner(); return;
    }

    if(scanMode === "labor"){
      if(!isOperatorBadge(code)){ setStatus("无效工牌（DA-... 或 EMP-...|名字）", false); return; }
      const p = parseBadge(code);
      await submitEvent({ event: laborAction, biz: laborBiz, task: laborTask, pick_session_id: currentSessionId, da_id: p.raw });

      if(laborTask === "PICK"){
        if(laborAction === "join") activePick.add(p.raw);
        if(laborAction === "leave") activePick.delete(p.raw);
      }
      if(laborTask === "RELABEL"){
        if(laborAction === "join") activeRelabel.add(p.raw);
        if(laborAction === "leave") activeRelabel.delete(p.raw);
      }
      renderActiveLists();

      alert((laborAction === "join" ? "已加入 ✅ " : "已退出 ✅ ") + p.raw);
      setStatus((laborAction === "join" ? "加入成功 ✅ " : "退出成功 ✅ ") + p.raw, true);
      await closeScanner(); return;
    }

    if(scanMode === "leaderLoginPick"){
      if(!isOperatorBadge(code)){ setStatus("无效工牌（请扫 EMP-xxx|名字）", false); return; }
      const p = parseBadge(code);
      if(!p.id.startsWith("EMP-")){ setStatus("请扫组长员工工牌（EMP-xxx|名字）", false); return; }
      leaderPickBadge = p.raw; localStorage.setItem("leader_pick_badge", leaderPickBadge);
      leaderPickOk = true; syncLeaderPickUI();
      alert("组长登录成功 ✅ " + p.raw);
      setStatus("组长登录成功 ✅", true);
      await closeScanner(); return;
    }

    if(scanMode === "leaderEndPick"){
      if(!isOperatorBadge(code)){ setStatus("无效工牌（请扫 EMP-xxx|名字）", false); return; }
      const p = parseBadge(code);
      if(!p.id.startsWith("EMP-")){ setStatus("请扫组长员工工牌（EMP-xxx|名字）", false); return; }
      if(activePick.size > 0){ setStatus("还有人员未退出，禁止结束", false); alert("还有人员未退出作业，不能结束拣货。"); await closeScanner(); return; }

      leaderPickBadge = p.raw; localStorage.setItem("leader_pick_badge", leaderPickBadge);
      const biz = pendingLeaderEnd?.biz || "B2C";
      const task = pendingLeaderEnd?.task || "PICK";
      await submitEvent({ event:"end", biz: biz, task: task, pick_session_id: currentSessionId });

      alert("已由组长确认结束 ✅ " + p.raw);
      setStatus("结束已记录 ✅（组长确认）", true);

      currentSessionId = null;
      localStorage.removeItem("pick_session_id");
      pendingLeaderEnd = null;
      leaderPickOk = false;
      refreshUI(); syncLeaderPickUI();

      await closeScanner(); return;
    }
  };

  try{
    await scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 240, height: 240 } }, onScan);
  }catch(e){
    const cams = await Html5Qrcode.getCameras();
    const camId = cams?.[0]?.id;
    await scanner.start(camId, { fps:10, qrbox:{width:240,height:240}}, onScan);
  }
}
async function closeScanner(){
  try{
    if(scanner){
      await scanner.stop();
      await scanner.clear();
      scanner = null;
    }
  }catch(e){}
  hideOverlay();
}
</script>
</body>
</html>
